<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SYSTEM CORE - LOBBY</title>
    
    <link rel="stylesheet" href="avatarframe.css">
    <script src="nguoigaccong.js"></script>
    <script src="avatarframe.js"></script>

    <style>
        /* --- GIỮ NGUYÊN CSS GỐC CỦA BẠN --- */
        :root { --neon: #00f2ff; }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%;
            background: #02050a url('./farfuture01.png') center bottom / cover no-repeat fixed;
            font-family: 'Segoe UI', sans-serif; color: #fff; 
            
            /* --- CÁC LỆNH KHÓA MÀN HÌNH (ĐÃ THÊM) --- */
            overflow: hidden !important;      /* Cắt bỏ mọi phần dư thừa */
            overflow-x: hidden !important;    /* Chặn tuyệt đối kéo ngang */
            overflow-y: hidden !important;    /* Chặn tuyệt đối kéo dọc */
            position: fixed;                  /* Ghim chặt body, chống kéo lò xo */
            touch-action: none;               /* Tắt cảm ứng vuốt cuộn */
            overscroll-behavior: none;        /* Tắt hiệu ứng nảy trang */
            
            transition: background-image 0.5s ease-in-out;
        }

        /* --- BỔ SUNG CSS CHO HIỆU ỨNG NỔ --- */
        #explosion-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; 
            z-index: 100; 
        }
        
        /* --- KHUNG HUD MỚI --- */
        #hud-container {
            position: absolute; 
            top: -20px; 
            left: 32%; 
            transform: translateX(-50%); 
            width: 500px; 
            
            /* Thêm max-width để đảm bảo không bị bung ngang trên màn hình nhỏ */
            max-width: 100%; 
            
            height: 200px; 
            z-index: 20;
            pointer-events: none; 
        }

        #hudCanvas {
            position: absolute; top: 0; left: 0;
            filter: drop-shadow(0 0 5px rgba(0, 242, 255, 0.2));
        }

        /* Vùng chứa Avatar + Frame (Click để vào Profile) - ĐÃ SỬA ONCLICK */
        #profile-trigger {
            position: absolute;
            /* Tọa độ tính toán dựa trên Canvas: cx=150, cy=100. Size 100x100 để nằm gọn trong r=60 */
            top: 50px; 
            left: 100px; 
            width: 100px; 
            height: 100px; 
            border-radius: 50%;
            cursor: pointer;
            pointer-events: auto; 
            z-index: 25;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #hud-avatar-img {
            width: 100%; height: 100%; 
            border-radius: 50%; 
            object-fit: cover;
            display: none; 
            position: relative; 
            z-index: 1;
        }

        /* Container cho Frame (Đè lên ảnh) - ĐÃ SỬA LỖI SIZE */
        #hud-frame-target {
            position: absolute;
            top: 50%; left: 50%;
            /* Fix lỗi to: Scale nhỏ lại 0.85 và căn giữa tuyệt đối */
            transform: translate(-50%, -50%) scale(0.85); 
            width: 140px; height: 140px;
            pointer-events: none;
            z-index: 2;
            display: flex; justify-content: center; align-items: center;
        }

        /* Chữ System Core nằm trong thanh HUD */
        .hud-text {
            position: absolute;
            top: 92px;
            left: 235px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 14px;
            width: 250px; 
            letter-spacing: 4px;
            color: var(--neon);
            text-shadow: 0 0 8px var(--neon);
            pointer-events: none;
        }

        #dust-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1; 
        }

        .dust {
            position: absolute; background: var(--neon); border-radius: 50%;
            box-shadow: 0 0 6px var(--neon), 0 0 12px rgba(0, 242, 255, 0.6);
            opacity: 0.6; animation: float linear infinite;
        }

        @keyframes float {
            0%   { transform: translateY(110vh) scale(0.3); opacity: 0; }
            15%  { opacity: 0.8; }
            80%  { opacity: 0.6; }
            100% { transform: translateY(-20vh) scale(1); opacity: 0; }
        }

        /* Task Wrapper GỐC */
        .task-wrapper {
            position: relative; width: 100%; height: 110px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .svg-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; overflow: visible;
        }

        .beam { fill: none; stroke-linecap: round; stroke-linejoin: round; transition: all 0.3s ease; }
        .core-beam { stroke: var(--neon); stroke-width: 1.5; fill: rgba(0, 242, 255, 0.02); }
        .shell-beam { stroke: var(--neon); stroke-width: 2.5; opacity: 0.8; }

        .content { display: flex; flex-direction: column; align-items: center; z-index: 2; pointer-events: none; }
        .icon { 
            width: 32px; height: 32px; fill: none; stroke: var(--neon); stroke-width: 1.2; 
            margin-bottom: 8px; filter: url(#neonGlow); transition: 0.3s;
        }
        .label { 
            color: var(--neon); font-size: 11px; letter-spacing: 1.5px; font-weight: bold; 
            text-shadow: 0 0 5px var(--neon); transition: 0.3s; text-transform: uppercase;
        }

        .task-wrapper:hover .shell-beam { stroke: var(--neon); stroke-width: 3.5; filter: url(#strongGlow); opacity: 1; }
        .task-wrapper:hover .core-beam { stroke: var(--neon); stroke-width: 2; filter: url(#strongGlow); fill: rgba(0, 242, 255, 0.15); }
        .task-wrapper:hover .icon { transform: scale(1.1); filter: drop-shadow(0 0 8px var(--neon)); }
        .task-wrapper:hover .label { text-shadow: 0 0 15px var(--neon); }
        .task-wrapper:active .core-beam { stroke: #fff; filter: url(#strongGlow); }

        /* --- PHẦN BỔ SUNG MỚI --- */
        
        #viewport {
            width: 100vw; height: 100vh; /* Khóa cứng chiều cao */
            overflow: hidden; position: relative; z-index: 10;
        }
        
        #page-container {
            display: flex; width: 100vw; height: 100%;
        }

        .page {
            width: 100vw; height: 100%;
            display: flex; flex-direction: column; align-items: center;
            overflow: hidden; /* Chặn cuộn trang con */
        }

        .grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px 20px; 
            width: 90%; max-width: 500px; 
            margin: 150px auto 100px auto; 
            position: relative;
        }

        .ctrl-btn {
            position: fixed; bottom: 40px; width: 55px; height: 55px;
            border: 1px solid var(--neon); border-radius: 50%;
            background: rgba(0, 5, 10, 0.6); backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 100; box-shadow: 0 0 10px rgba(0, 242, 255, 0.2);
            transition: 0.3s;
            -webkit-tap-highlight-color: transparent;
        }
        .ctrl-btn:active { background: var(--neon); box-shadow: 0 0 25px var(--neon); }
        .ctrl-btn svg { width: 24px; height: 24px; fill: none; stroke: var(--neon); stroke-width: 2; transition: 0.3s; }
        .ctrl-btn:active svg { stroke: #000; }
        
        .btn-left { left: 30px; }
        .btn-right { right: 30px; }

        /* --- CSS CHO POPUP CẢNH BÁO (MỚI BỔ SUNG) --- */
        #warningModal {
            display: none; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 5, 10, 0.85);
            backdrop-filter: blur(8px);
            z-index: 9999;
            align-items: center; justify-content: center;
            flex-direction: column;
        }
        .modal-box {
            width: 80%; max-width: 320px;
            padding: 25px;
            border: 1px solid #ff4444; /* Viền đỏ cảnh báo */
            background: rgba(20, 0, 0, 0.9); /* Nền đỏ đen */
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.2), inset 0 0 10px rgba(255, 0, 0, 0.1);
            text-align: center;
            position: relative;
            transform: scale(0.9);
            animation: modalPop 0.3s forwards;
        }
        @keyframes modalPop { to { transform: scale(1); } }
        
        .modal-box h2 {
            margin: 0 0 15px 0; color: #ff4444; /* Tiêu đề đỏ */
            font-size: 18px; letter-spacing: 2px; text-transform: uppercase;
            text-shadow: 0 0 10px #ff0000;
            border-bottom: 1px dashed rgba(255, 68, 68, 0.3);
            padding-bottom: 10px;
        }
        .modal-box p {
            font-size: 13px; color: #ccc; line-height: 1.5; margin-bottom: 25px;
        }
        .modal-btn {
            background: transparent; border: 1px solid var(--neon);
            color: var(--neon); padding: 10px 20px;
            font-family: inherit; font-weight: bold; cursor: pointer;
            transition: 0.3s; text-transform: uppercase;
        }
        .modal-btn:hover, .modal-btn:active {
            background: var(--neon); color: #000; box-shadow: 0 0 15px var(--neon);
        }
        
    </style>
</head>
<body>
    
    <canvas id="explosion-canvas"></canvas>

    <div id="hud-container">
        <canvas id="hudCanvas"></canvas>
        
        <div id="profile-trigger" onclick="checkProfileAccess()">
            <img id="hud-avatar-img" src="" alt="Avatar">
            <div id="hud-frame-target"></div> 
        </div>

        <div class="hud-text">SYSTEM CORE</div>
    </div>

    <div id="dust-container"></div>

    <div class="ctrl-btn btn-left" id="bgBtn" onclick="checkBgAccess()">
        <svg viewBox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 0 1 2.828 0L16 16m-2-2l1.586-1.586a2 2 0 0 1 2.828 0L20 14m-6-6h.01M6 20h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2z"/></svg>
    </div>

    <div class="ctrl-btn btn-right" id="navBtn" onclick="location.replace('hologram1.html')">
        <svg viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
    </div>

    <div id="warningModal">
        <div class="modal-box">
            <h2>QUYỀN HẠN KHÔNG ĐỦ</h2>
            <p>Bạn cần nâng cấp lên quyền hạn OPERATOR để truy cập tính năng này.</p>
            <button class="modal-btn" onclick="closeWarningModal()">ĐÃ RÕ</button>
        </div>
    </div>

    <svg style="position: absolute; width: 0; height: 0; overflow: hidden;">
        <defs>
            <filter id="neonGlow"><feGaussianBlur stdDeviation="2" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
            <filter id="strongGlow"><feGaussianBlur stdDeviation="5" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>

            <linearGradient id="grad1" x1="0" y1="0" x2="1" y2="1"><stop offset="10%" stop-color="white" /><stop offset="40%" stop-color="#222" /><stop offset="60%" stop-color="#222" /><stop offset="90%" stop-color="white" /></linearGradient>
            <mask id="mask1"><rect x="-100" y="-100" width="500" height="500" fill="url(#grad1)" /></mask>

            <linearGradient id="grad2" x1="1" y1="0" x2="0" y2="1"><stop offset="10%" stop-color="white" /><stop offset="40%" stop-color="#222" /><stop offset="60%" stop-color="#222" /><stop offset="90%" stop-color="white" /></linearGradient>
            <mask id="mask2"><rect x="-100" y="-100" width="500" height="500" fill="url(#grad2)" /></mask>

            <linearGradient id="grad3" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stop-color="white" /><stop offset="30%" stop-color="#111" /><stop offset="70%" stop-color="#111" /><stop offset="95%" stop-color="white" /></linearGradient>
            <mask id="mask3"><rect x="-100" y="-100" width="500" height="500" fill="url(#grad3)" /></mask>

             <linearGradient id="grad4" x1="0" y1="0" x2="1" y2="0"><stop offset="10%" stop-color="white" /><stop offset="45%" stop-color="#000" /><stop offset="55%" stop-color="#000" /><stop offset="90%" stop-color="white" /></linearGradient>
            <mask id="mask4"><rect x="-100" y="-100" width="500" height="500" fill="url(#grad4)" /></mask>
        </defs>
    </svg>

    <div id="viewport">
        <div id="page-container">
            
            <div class="page">
                <div class="grid">
                    <div class="task-wrapper" onclick="openPortal('daily')">
                        <svg class="svg-container" viewBox="-20 -20 240 160">
                            <path class="beam core-beam" filter="url(#neonGlow)" d="M 15,0 L 185,0 L 200,15 L 200,105 L 185,120 L 15,120 L 0,105 L 0,15 Z" />
                            <path class="beam shell-beam" filter="url(#neonGlow)" mask="url(#mask1)" d="M 15,-12 L 185,-12 L 212,15 L 212,105 L 185,132 L 15,132 L -12,105 L -12,15 Z" />
                        </svg>
                        <div class="content"><svg class="icon" viewBox="0 0 24 24"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg><div class="label">CHI TIÊU</div></div>
                    </div>

                    <div class="task-wrapper" onclick="openPortal('budget')">
                        <svg class="svg-container" viewBox="-20 -20 240 160">
                            <path class="beam core-beam" filter="url(#neonGlow)" d="M 15,0 L 185,0 L 200,15 L 200,105 L 185,120 L 15,120 L 0,105 L 0,15 Z" />
                            <path class="beam shell-beam" filter="url(#neonGlow)" mask="url(#mask2)" d="M 15,-12 L 185,-12 L 212,15 L 212,105 L 185,132 L 15,132 L -12,105 L -12,15 Z" />
                        </svg>
                        <div class="content"><svg class="icon" viewBox="0 0 24 24"><path d="M18 20V10M12 20V4M6 20v-6"/></svg><div class="label">BIẾN ĐỘNG</div></div>
                    </div>

                    <div class="task-wrapper" onclick="openPortal('status')">
                        <svg class="svg-container" viewBox="-20 -20 240 160">
                            <path class="beam core-beam" filter="url(#neonGlow)" d="M 15,0 L 185,0 L 200,15 L 200,105 L 185,120 L 15,120 L 0,105 L 0,15 Z" />
                            <path class="beam shell-beam" filter="url(#neonGlow)" mask="url(#mask3)" d="M 15,-12 L 185,-12 L 212,15 L 212,105 L 185,132 L 15,132 L -12,105 L -12,15 Z" />
                        </svg>
                        <div class="content"><svg class="icon" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg><div class="label">AI SOI VÍ</div></div>
                    </div>

                    <div class="task-wrapper" onclick="openPortal('history')">
                        <svg class="svg-container" viewBox="-20 -20 240 160">
                            <path class="beam core-beam" filter="url(#neonGlow)" d="M 15,0 L 185,0 L 200,15 L 200,105 L 185,120 L 15,120 L 0,105 L 0,15 Z" />
                            <path class="beam shell-beam" filter="url(#neonGlow)" mask="url(#mask4)" d="M 15,-12 L 185,-12 L 212,15 L 212,105 L 185,132 L 15,132 L -12,105 L -12,15 Z" />
                        </svg>
                        <div class="content"><svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg><div class="label">LỊCH SỬ</div></div>
                    </div>

                    <div class="task-wrapper" onclick="openPortal('alloc')">
                        <svg class="svg-container" viewBox="-20 -20 240 160">
                            <path class="beam core-beam" filter="url(#neonGlow)" d="M 15,0 L 185,0 L 200,15 L 200,105 L 185,120 L 15,120 L 0,105 L 0,15 Z" />
                            <path class="beam shell-beam" filter="url(#neonGlow)" mask="url(#mask1)" d="M 15,-12 L 185,-12 L 212,15 L 212,105 L 185,132 L 15,132 L -12,105 L -12,15 Z" />
                        </svg>
                        <div class="content"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg><div class="label">PHÂN BỔ</div></div>
                    </div>

                    <div class="task-wrapper" onclick="openPortal('settings')">
                        <svg class="svg-container" viewBox="-20 -20 240 160">
                            <path class="beam core-beam" filter="url(#neonGlow)" d="M 15,0 L 185,0 L 200,15 L 200,105 L 185,120 L 15,120 L 0,105 L 0,15 Z" />
                            <path class="beam shell-beam" filter="url(#neonGlow)" mask="url(#mask2)" d="M 15,-12 L 185,-12 L 212,15 L 212,105 L 185,132 L 15,132 L -12,105 L -12,15 Z" />
                        </svg>
                        <div class="content"><svg class="icon" viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg><div class="label">CÀI ĐẶT</div></div>
                    </div>
                </div>
            </div>
            
            </div>
    </div>

    <script>
        // --- 1. SCRIPT VẼ KHUNG HUD (CỦA BẠN) ---
        const hudCanvas = document.getElementById('hudCanvas');
        const hudCtx = hudCanvas.getContext('2d');

        const W = 500; 
        const H = 200; 
        hudCanvas.width = W; 
        hudCanvas.height = H;

        const COLOR = "#00f2ff"; 

        function drawHudFrame() {
            hudCtx.clearRect(0, 0, W, H);
            
            const r = 60;        
            const barH = 55;     
            const drawingWidth = 320; 
            
            const startX = (W - drawingWidth) / 2; 
            const cy = H / 2;                      
            const cx = startX + r;                 
            
            const barStart = cx + r - 5; 
            const barLen = startX + drawingWidth - 30;

            // 1. VÒNG TRÒN NỀN MỜ
            hudCtx.shadowBlur = 0; 
            hudCtx.strokeStyle = "rgba(0, 242, 255, 0.15)"; 
            hudCtx.lineWidth = 1;
            
            hudCtx.setLineDash([2, 4]); 
            hudCtx.beginPath();
            hudCtx.arc(cx, cy, r, 0, Math.PI * 2);
            hudCtx.stroke();

            hudCtx.setLineDash([]); 
            hudCtx.beginPath();
            hudCtx.arc(cx, cy, r - 8, 0, Math.PI * 2);
            hudCtx.stroke();

            // 2. THANH KHUNG DÀI
            hudCtx.strokeStyle = COLOR;
            hudCtx.shadowColor = COLOR;
            hudCtx.shadowBlur = 10; 
            hudCtx.lineWidth = 2;
            hudCtx.lineCap = "round";
            hudCtx.lineJoin = "round";

            let topY = cy - (barH / 2);
            let botY = cy + (barH / 2);

            hudCtx.beginPath();
            hudCtx.moveTo(barStart, topY); 
            hudCtx.lineTo(barStart + 15, topY); 
            hudCtx.lineTo(barStart + 25, topY - 5); 
            hudCtx.lineTo(barLen - 40, topY - 5); 
            hudCtx.lineTo(barLen - 30, topY); 
            hudCtx.lineTo(barLen, topY); 

            hudCtx.lineTo(barLen + 15, cy - 8); 
            hudCtx.lineTo(barLen + 15, cy + 8); 
            hudCtx.lineTo(barLen, botY); 

            hudCtx.lineTo(barStart + 80, botY); 
            hudCtx.lineTo(barStart + 70, botY + 5); 
            hudCtx.lineTo(barStart + 35, botY + 5); 
            hudCtx.lineTo(barStart + 25, botY); 
            hudCtx.lineTo(barStart, botY); 
            hudCtx.stroke();

            // 3. CHI TIẾT PHỤ
            hudCtx.shadowBlur = 5;
            hudCtx.lineWidth = 1;
            hudCtx.beginPath();
            hudCtx.moveTo(barStart + 40, botY + 12);
            hudCtx.lineTo(barStart + 100, botY + 12);
            hudCtx.stroke();

            hudCtx.lineWidth = 2;
            hudCtx.beginPath();
            hudCtx.moveTo(barStart + 12, topY + 8);
            hudCtx.lineTo(barStart + 6, botY - 8);
            hudCtx.stroke();
        }

        drawHudFrame();

        // --- 2. SCRIPT TẢI AVATAR & FRAME (CẮT DÁN TỪ PROFILEBASIC) ---
        function loadLobbyAvatar() {
            // Lấy ảnh từ LocalStorage
            const savedAvatar = localStorage.getItem('USER_AVATAR_BASE64');
            const img = document.getElementById('hud-avatar-img');
            
            if (savedAvatar) {
                img.src = savedAvatar;
                img.style.display = 'block';
            }

            // Gọi linh kiện khung Rank (Nếu script avatarframe.js đã load)
            if (typeof AvatarFrameManager !== 'undefined') {
                // Render vào div id="hud-frame-target"
                AvatarFrameManager.render('hud-frame-target');
            }
        }

        // --- 3. SCRIPT HIỆU ỨNG MẢNH VỠ (NEON SHARDS) ---
        const cv = document.getElementById("explosion-canvas");
        const ctx = cv.getContext("2d");
        let shards = [];

        function resize() { cv.width = window.innerWidth; cv.height = window.innerHeight; }
        window.onresize = resize;
        resize();

        class NeonShard {
            constructor(x, y, isSparkle = false) {
                this.x = x; this.y = y; this.isSparkle = isSparkle;
                this.life = 1.0;
                this.decay = isSparkle ? 0.03 : 0.02 + Math.random() * 0.02;
                
                const angle = Math.random() * Math.PI * 2;
                const speed = isSparkle ? (1 + Math.random() * 4) : (3 + Math.random() * 4);
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;

                this.size = isSparkle ? (Math.random() * 2) : (5 + Math.random() * 8);
                this.widthRatio = 0.3 + Math.random() * 0.4;
                this.rot = angle; 
                this.vRot = (Math.random() - 0.5) * 0.3;
            }

            update() {
                this.vx *= 0.95; this.vy *= 0.95;
                this.x += this.vx; this.y += this.vy;
                this.rot += this.vRot; this.life -= this.decay;
            }

            draw() {
                if(this.life <= 0) return;
                ctx.globalCompositeOperation = "lighter";
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rot);
                
                const alpha = this.life;
                const flicker = 0.8 + Math.random() * 0.2; 

                ctx.beginPath();
                if (this.isSparkle) {
                    ctx.arc(0, 0, this.size, 0, Math.PI * 2);
                } else {
                    ctx.moveTo(0, -this.size);
                    ctx.lineTo(this.size * this.widthRatio, this.size);
                    ctx.lineTo(-this.size * this.widthRatio, this.size);
                }
                ctx.closePath();

                ctx.shadowBlur = (this.isSparkle ? 5 : 20) * alpha;
                ctx.shadowColor = "#00f2ff";
                
                ctx.strokeStyle = `rgba(0, 242, 255, ${alpha * flicker})`;
                ctx.lineWidth = this.isSparkle ? 1 : 1.5;
                ctx.stroke();

                if (!this.isSparkle) {
                    ctx.fillStyle = `rgba(255, 255, 255, ${alpha * 0.15})`;
                    ctx.fill();
                    ctx.strokeStyle = `rgba(255, 255, 255, ${alpha * 0.8})`;
                    ctx.lineWidth = 0.5;
                    ctx.stroke();
                } else {
                    ctx.fillStyle = `rgba(255, 255, 255, ${alpha})`;
                    ctx.fill();
                }
                ctx.restore();
                ctx.globalCompositeOperation = "source-over";
            }
        }

        function animate() {
            ctx.clearRect(0, 0, cv.width, cv.height);
            shards = shards.filter(s => s.life > 0);
            shards.forEach(s => { s.update(); s.draw(); });
            requestAnimationFrame(animate);
        }
        animate();

        window.addEventListener('mousedown', e => {
            for(let i=0; i<5; i++) shards.push(new NeonShard(e.clientX, e.clientY, false));
            for(let i=0; i<8; i++) shards.push(new NeonShard(e.clientX, e.clientY, true));
        });
        window.addEventListener('touchstart', e => {
            const t = e.touches[0];
            for(let i=0; i<5; i++) shards.push(new NeonShard(t.clientX, t.clientY, false));
            for(let i=0; i<8; i++) shards.push(new NeonShard(t.clientX, t.clientY, true));
        });

        // 4. BỤI CÔNG NGHỆ
        function createDust() {
            const container = document.getElementById('dust-container');
            const particleCount = 80;

            for (let i = 0; i < particleCount; i++) {
                const dust = document.createElement('div');
                dust.className = 'dust';
                const size = Math.random() * 4 + 2; 
                dust.style.width = size + 'px'; dust.style.height = size + 'px';
                dust.style.left = Math.random() * 100 + 'vw';
                const duration = Math.random() * 12 + 8; 
                dust.style.animationDuration = duration + 's';
                dust.style.animationDelay = '-' + (Math.random() * duration) + 's';
                container.appendChild(dust);
            }
        }
        createDust();

        function openPortal(taskName) {
            window.location.href = `./index.html?task=${taskName}`;
        }

        // --- TRẠM ĐIỀU HÀNH BACKGROUND GHI ĐÈ ---
        window.addEventListener('storage', (e) => {
            if (e.key === 'AURA_COMMAND_BG' && e.newValue) {
                const targetBg = e.newValue;
                
                // 1. Thực hiện đổi nền ngay lập tức
                document.body.style.backgroundImage = `url('./${targetBg}')`;
                
                // 2. Cập nhật chỉ số Index để nút bấm thủ công không bị lệch vòng lặp (Tùy chọn)
                if (typeof bgFiles !== 'undefined') {
                    const newIndex = bgFiles.indexOf(targetBg);
                    if (newIndex !== -1) bgIndex = newIndex;
                }

                // 3. Lưu làm nền mặc định bền vững
                localStorage.setItem('user_lobby_bg', targetBg);
                
                console.log("Điều hành: Đã ghi đè nền hệ thống thành -> " + targetBg);
            }
        });

        // --- HÀM KIỂM TRA QUYỀN HẠN (MỚI BỔ SUNG) ---
        function checkBgAccess() {
            if (typeof NguoiGacCong !== 'undefined') {
                const identity = NguoiGacCong.traLoiDanhTinh();
                // Level < 2 (Initiator) -> Chặn
                if (identity.level < 2) {
                    document.getElementById('warningModal').style.display = 'flex';
                } else {
                    // Level >= 2 -> Cho phép
                    window.location.href = 'backgroundchoose.html';
                }
            } else {
                // Fallback nếu không có NguoiGacCong
                window.location.href = 'backgroundchoose.html';
            }
        }

        // --- HÀM KIỂM TRA TRUY CẬP PROFILE (MỚI BỔ SUNG) ---
        function checkProfileAccess() {
            if (typeof NguoiGacCong !== 'undefined') {
                const identity = NguoiGacCong.traLoiDanhTinh();
                // Level = 4 (Orchestrator) -> profileultra
                if (identity.level === 4) {
                    window.location.href = 'profileultra.html';
                } else {
                    // Level 1, 2, 3 -> profilebasic
                    window.location.href = 'profilebasic.html';
                }
            } else {
                window.location.href = 'profilebasic.html';
            }
        }

        function closeWarningModal() {
            document.getElementById('warningModal').style.display = 'none';
        }

        // 5. LOAD ẢNH NỀN KHI KHỞI ĐỘNG (Logic cũ)
        window.onload = function() {
            // Load Background
            const savedBg = localStorage.getItem('user_lobby_bg');
            if (savedBg) {
                document.body.style.backgroundImage = `url('./${savedBg}')`;
            } else {
                document.body.style.backgroundImage = `url('./farfuture01.png')`;
            }

            // Load Avatar & Frame
            loadLobbyAvatar();
        };
    </script>
    <style>
    /* 1. NÚT TRIGGER (MŨI TÊN CHỈ LÊN KIỂU PROFILEULTRA) */
    #task-trigger-container {
        position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
        z-index: 4000; cursor: pointer; padding: 10px;
        animation: pulseUp 2s infinite; */
    pointer-events: auto;
    }
    #task-trigger-icon {
        transform: rotate(-90deg); /* Xoay mũi tên lên */
        display: inline-block;
        color: transparent;
        -webkit-text-stroke: 1.5px var(--neon); /* Viền neon */
        text-shadow: 0 0 15px var(--neon), 0 0 30px var(--neon);
        font-size: 35px; font-family: 'Courier New', monospace;
        font-weight: 100; letter-spacing: -4px;
        transition: 0.3s;
    }
    #task-trigger-container:hover #task-trigger-icon {
        -webkit-text-stroke: 2.5px var(--neon);
        text-shadow: 0 0 25px var(--neon), 0 0 50px var(--neon);
    }
    @keyframes pulseUp { 
        0%, 100% { bottom: 5px; opacity: 0.7; } 
        50% { bottom: 20px; opacity: 1; } 
    }

    /* 2. OVERLAY & CARD CHÍNH */
    #task-popup {
        display: none; position: fixed; inset: 0; z-index: 4001;
        background: rgba(0, 5, 15, 0.7); backdrop-filter: blur(10px); /* Nền mờ, không đen đặc */
        align-items: center; justify-content: center;
    }
    .task-card {
        width: 80%; max-width: 450px; /* Chiều rộng 80% */
        background: rgba(0, 10, 20, 0.85); border: 1px solid var(--neon);
        border-radius: 12px; padding: 30px 25px; /* Tăng padding */
        box-shadow: 0 0 40px rgba(0, 242, 255, 0.2), inset 0 0 15px rgba(0, 242, 255, 0.1);
        animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    /* 3. TASK ITEMS (LỚN HƠN) */
    .task-item {
        display: flex; flex-direction: column; gap: 8px;
        padding: 18px 20px; margin-bottom: 15px; 
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(0, 0, 0, 0.5);
        border-radius: 8px; cursor: pointer; transition: 0.3s;
    }
    .task-name { font-weight: bold; font-size: 16px; letter-spacing: 2px; text-transform: uppercase; }
    .task-desc { font-size: 12px; line-height: 1.5; opacity: 0.8; }

    /* 3 Task đầu: FULL ĐỎ */
    .task-danger { border-color: rgba(255, 51, 51, 0.5); }
    .task-danger .task-name { color: #ff3333; text-shadow: 0 0 10px #ff3333; }
    .task-danger .task-desc { color: #ff9999; }
    .task-danger:hover { 
        background: rgba(255, 51, 51, 0.15); border-color: #ff3333; 
        box-shadow: 0 0 20px rgba(255, 51, 51, 0.4); transform: translateX(5px);
    }

    /* Task Hộp thư: FULL XANH NEON */
    .task-mail { border-style: dashed; border-color: rgba(0, 242, 255, 0.6); }
    .task-mail .task-name { color: var(--neon); text-shadow: 0 0 10px var(--neon); }
    .task-mail .task-desc { color: rgba(0, 242, 255, 0.8); }
    .task-mail:hover { 
        background: rgba(0, 242, 255, 0.15); border-color: var(--neon); 
        box-shadow: 0 0 20px rgba(0, 242, 255, 0.4); transform: translateX(5px);
    }

    /* 4. NÚT NEON CHUẨN (CHO ĐÓNG VÀ POPUP) */
    .neon-btn {
        background: transparent; padding: 12px 20px; margin-top: 15px; width: 100%;
        font-family: 'Courier New', monospace; font-weight: bold; font-size: 14px;
        cursor: pointer; transition: 0.3s; text-transform: uppercase; letter-spacing: 2px;
    }
    .neon-btn-blue { border: 1px solid var(--neon); color: var(--neon); }
    .neon-btn-blue:hover { background: var(--neon); color: #000; box-shadow: 0 0 15px var(--neon); }
    
    .neon-btn-red { border: 1px solid #ff3333; color: #ff3333; }
    .neon-btn-red:hover { background: #ff3333; color: #fff; box-shadow: 0 0 15px #ff3333; }

    /* 5. POPUP XÁC NHẬN (ĐỎ) & POPUP THƯ (XANH) */
    .modal-overlay {
        display: none; position: fixed; inset: 0; z-index: 4005;
        background: rgba(0,0,0,0.8); align-items: center; justify-content: center;
        backdrop-filter: blur(5px);
    }
    .modal-box-red {
        width: 85%; max-width: 320px; background: rgba(15, 0, 0, 0.95); 
        border: 1px solid #ff3333; padding: 25px; text-align: center; 
        border-radius: 8px; box-shadow: 0 0 30px rgba(255,51,51,0.3);
        animation: popIn 0.3s forwards;
    }
    .modal-box-blue {
        width: 85%; max-width: 320px; background: rgba(0, 10, 15, 0.95); 
        border: 1px dashed var(--neon); padding: 25px; text-align: center; 
        border-radius: 8px; box-shadow: 0 0 30px rgba(0,242,255,0.2);
        animation: popIn 0.3s forwards;
    }
</style>

<div id="task-trigger-container" onclick="openTaskbar()">
    <div id="task-trigger-icon">»</div>
</div>

<div id="task-popup">
    <div class="task-card">
        <div style="text-align: center; color: var(--neon); font-size: 12px; font-weight: bold; letter-spacing: 4px; margin-bottom: 25px; opacity: 0.8;">[ SYSTEM TASK MANAGER ]</div>

        <div class="task-item task-danger" onclick="confirmTask('assistant')">
            <div class="task-name">RESTART ASSISTANT</div>
            <div class="task-desc">Gửi tín hiệu khởi động lại toàn bộ trợ lý hướng dẫn cho các giao diện.</div>
        </div>

        <div class="task-item task-danger" onclick="confirmTask('level')">
            <div class="task-name">RESET AUTHORIZATION</div>
            <div class="task-desc">Xóa quyền hạn hiện tại, đưa trạng thái hệ thống về INITIATOR.</div>
        </div>

        <div class="task-item task-danger" onclick="confirmTask('data')">
            <div class="task-name">WIPE APP DATA</div>
            <div class="task-desc">Xóa sạch ví và ngân sách.</div>
        </div>

        <div class="task-item task-mail" onclick="showMailModal()">
            <div class="task-name">✉ SYSTEM MAILBOX</div>
            <div class="task-desc">Nhận dữ liệu thông tin và thư từ quản trị viên hệ thống.</div>
        </div>

        <button class="neon-btn neon-btn-blue" style="margin-top: 25px;" onclick="closeTaskbar()">ĐÓNG BẢNG LỆNH</button>
    </div>
</div>

<div id="confirm-overlay" class="modal-overlay">
    <div class="modal-box-red">
        <div style="color: #ff3333; font-weight: bold; font-size: 18px; letter-spacing: 2px; margin-bottom: 15px; text-shadow: 0 0 10px #ff3333;">XÁC NHẬN LỆNH</div>
        <div id="confirm-text" style="color: #ff9999; font-size: 13px; margin-bottom: 25px; line-height: 1.6;"></div>
        <div style="display: flex; gap: 15px;">
            <button class="neon-btn neon-btn-blue" style="margin-top: 0;" onclick="hideConfirm()">HỦY</button>
            <button class="neon-btn neon-btn-red" style="margin-top: 0;" id="exec-btn">THỰC THI</button>
        </div>
    </div>
</div>

<div id="mail-overlay" class="modal-overlay">
    <div class="modal-box-blue">
        <div style="color: var(--neon); font-weight: bold; font-size: 18px; letter-spacing: 2px; margin-bottom: 15px; text-shadow: 0 0 10px var(--neon);">✉ INBOX EMPTY</div>
        <div style="color: rgba(0,242,255,0.8); font-size: 13px; margin-bottom: 25px; line-height: 1.6;">
            Trạm thư trống. Hiện tại chưa có dữ liệu chỉ thị mới từ hệ thống quản trị AURA.
        </div>
        <button class="neon-btn neon-btn-blue" style="margin-top: 0;" onclick="hideMailModal()">ĐÃ RÕ</button>
    </div>
</div>

<script>
    let pendingTask = "";

    function openTaskbar() { document.getElementById('task-popup').style.display = 'flex'; }
    function closeTaskbar() { document.getElementById('task-popup').style.display = 'none'; }

    // Xử lý Popup Xác Nhận (Đỏ)
    function confirmTask(type) {
        pendingTask = type;
        const overlay = document.getElementById('confirm-overlay');
        const text = document.getElementById('confirm-text');
        overlay.style.display = 'flex';

        if(type === 'assistant') text.innerText = "Hệ thống sẽ xóa tín hiệu đã xem hướng dẫn. Bạn sẽ thấy trợ lý ở mọi giao diện trong lần tới. Tiếp tục?";
        if(type === 'level') text.innerText = "CẢNH BÁO: Giao thức này sẽ hạ cấp quyền hạn của bạn xuống mức thấp nhất (INITIATOR).";
        if(type === 'data') text.innerText = "CẢNH BÁO NGUY HIỂM: Toàn bộ ngân sách và ví sẽ bị xóa vĩnh viễn. Không thể khôi phục!";

        document.getElementById('exec-btn').onclick = runSystemTask;
    }
    function hideConfirm() { document.getElementById('confirm-overlay').style.display = 'none'; }

    // Xử lý Popup Hộp thư (Xanh)
    function showMailModal() { document.getElementById('mail-overlay').style.display = 'flex'; }
    function hideMailModal() { document.getElementById('mail-overlay').style.display = 'none'; }

    function runSystemTask() {
    if (pendingTask === 'assistant') {
        // --- LỆNH XÓA TỔNG LỰC ---
        Object.keys(localStorage).forEach(key => {
            const k = key.toLowerCase();
            // Xóa tất cả các key có chứa 'tut' (hệ thống mới) hoặc 'visited'/'seen' (hệ thống cũ)
            if (k.includes('tut') || k.includes('visited') || k.includes('seen')) {
                localStorage.removeItem(key);
                console.log("AURA System: Đã reset dữ liệu hướng dẫn -> " + key);
            }
        });
            localStorage.setItem('AURA_FIRST_TIME_SIGNAL', 'true');
        } 
        else if (pendingTask === 'level') {
            localStorage.setItem('AURA_CLEARANCE_LEVEL', 'INITIATOR-0');
        } 
        else if (pendingTask === 'data') {
            const currentLevel = localStorage.getItem('AURA_CLEARANCE_LEVEL');
            const assistantSignal = localStorage.getItem('AURA_FIRST_TIME_SIGNAL');
            localStorage.clear(); 
            if(currentLevel) localStorage.setItem('AURA_CLEARANCE_LEVEL', currentLevel);
            if(assistantSignal) localStorage.setItem('AURA_FIRST_TIME_SIGNAL', assistantSignal);
        }

        hideConfirm();
        closeTaskbar();
        // Thông báo bằng Mail xanh thay cho alert đen trắng trước khi reload
        const mailBox = document.querySelector('#mail-overlay .modal-box-blue');
        mailBox.innerHTML = `
            <div style="color: var(--neon); font-weight: bold; font-size: 18px; margin-bottom: 15px;">GIAO THỨC HOÀN TẤT</div>
            <div style="color: rgba(0,242,255,0.8); font-size: 13px; margin-bottom: 25px;">Hệ thống đang khởi động lại...</div>
        `;
        document.getElementById('mail-overlay').style.display = 'flex';
        setTimeout(() => location.reload(), 2000);
    }
</script>
    <script src="aura_assistant.js"></script>
    <script>
        window.addEventListener('load', () => {
            initAuraAssistant('lobby_core'); 
        });
    </script>
</body>
</html>

