<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI LEGACY - WEALTH STRATEGY</title>
    <style>
        /* --- 1. CẤU HÌNH GIAO DIỆN (COPY TỪ LENH01) --- */
        :root {
            --neon: #00f2ff;
            --neon-green: #00ff88;
            --neon-pink: #ff00ff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: #000 no-repeat center bottom / cover fixed;
            height: 100vh; width: 100vw;
            overflow: hidden;
            font-family: 'Courier New', monospace;
            color: var(--neon);
            display: flex; align-items: center; justify-content: center;
            perspective: 1500px;
            touch-action: none;
            transition: background-image 0.5s ease-in-out;
        }

        .overlay-dim {
            position: fixed; inset: 0;
            background: rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(5px);
            z-index: 1; pointer-events: none;
        }

        .hologram-container {
            position: relative; z-index: 10;
            width: 90vw; max-width: 700px; 
            height: 500px;
            transform-style: preserve-3d;
            animation: float 6s ease-in-out infinite;
            margin-top: -30px;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotateX(5deg) rotateY(-5deg); }
            50% { transform: translateY(-15px) rotateX(5deg) rotateY(-5deg); }
        }

        .screen {
            position: relative; width: 100%; height: 100%;
            background: linear-gradient(135deg, rgba(0, 242, 255, 0.05), rgba(0, 242, 255, 0.1));
            border: 2px solid var(--neon);
            box-shadow: 0 0 40px rgba(0, 242, 255, 0.4), inset 0 0 60px rgba(0, 242, 255, 0.2);
            transform-style: preserve-3d;
            overflow: hidden;
            display: flex; flex-direction: column;
            clip-path: polygon(
                20px 0, calc(100% - 20px) 0, 100% 20px, 100% calc(100% - 20px),
                calc(100% - 20px) 100%, 20px 100%, 0 calc(100% - 20px), 0 20px
            );
        }

        .screen::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 242, 255, 0.03) 2px, rgba(0, 242, 255, 0.03) 4px),
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0, 242, 255, 0.03) 2px, rgba(0, 242, 255, 0.03) 4px);
            pointer-events: none; z-index: 2;
        }

        .screen::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px;
            background: linear-gradient(90deg, transparent, var(--neon), transparent);
            box-shadow: 0 0 20px var(--neon);
            animation: scan 3s linear infinite; z-index: 3; opacity: 0.6;
        }
        @keyframes scan { 
            0% { transform: translateY(0); } 100% { transform: translateY(600px); } 
        }

        .header {
            position: relative; padding: 15px 30px;
            border-bottom: 2px solid rgba(0, 242, 255, 0.3);
            background: rgba(0, 5, 10, 0.85);
            z-index: 10; flex-shrink: 0;
        }
        .header h1 {
            font-size: 18px; letter-spacing: 3px;
            text-shadow: 
                0 0 12px var(--neon),
                0 0 28px var(--neon),
                0 0 50px var(--neon);
            animation: glow-text 2s ease-in-out infinite;
        }
        @keyframes glow-text {
            0%, 100% { 
                text-shadow: 
                    0 0 12px var(--neon), 
                    0 0 28px var(--neon),
                    0 0 50px var(--neon); 
            }
            50% { 
                text-shadow: 
                    0 0 24px var(--neon), 
                    0 0 60px var(--neon), 
                    0 0 100px var(--neon),
                    0 0 140px rgba(0, 242, 255, 0.6);
            }
        }
        .status {
            font-size: 11px; 
            color: var(--neon-green); 
            margin-top: 5px;
            display: flex; align-items: center; gap: 8px;
            text-shadow: 
                0 0 7px var(--neon-green),
                0 0 14px var(--neon-green),
                0 0 24px rgba(0, 255, 136, 0.7);
        }
        .status::before {
            content: ''; width: 6px; height: 6px; background: var(--neon-green);
            border-radius: 50%; box-shadow: 0 0 8px var(--neon-green); animation: blink 1s infinite;
        }
        @keyframes blink { 50% { opacity: 0.3; } }

        .content {
            padding: 20px 30px; flex-grow: 1; 
            overflow-y: auto;
            position: relative; z-index: 4;
            touch-action: pan-y;
            -webkit-overflow-scrolling: touch;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .content::-webkit-scrollbar { 
            display: none; 
        }

        .line {
            margin-bottom: 10px; font-size: 13px; letter-spacing: 1px;
            text-shadow: 
                0 0 6px var(--neon),
                0 0 14px var(--neon),
                0 0 24px rgba(0, 242, 255, 0.8);
            opacity: 0;
            transform: translateX(-10px); animation: text-appear 0.3s forwards;
        }
        @keyframes text-appear { to { opacity: 1; transform: translateX(0); } }

        .line.success {
            color: var(--neon-green);
            text-shadow: 
                0 0 8px var(--neon-green),
                0 0 18px var(--neon-green),
                0 0 32px rgba(0, 255, 136, 0.85);
        }

        .line.error {
            color: #ff0066;
            font-weight: bold;
            text-shadow: 
                0 0 9px #ff0066,
                0 0 20px #ff0066,
                0 0 38px rgba(255, 0, 102, 0.8);
        }

        .line.highlight {
            color: var(--neon-pink);
            font-weight: bold;
            text-shadow: 
                0 0 10px var(--neon-pink),
                0 0 24px var(--neon-pink),
                0 0 45px rgba(255, 0, 255, 0.8);
        }

        .line.system {
            color: #ffffff;
            font-style: italic;
            text-shadow: 
                0 0 5px rgba(136, 136, 136, 0.9),
                0 0 10px rgba(136, 136, 136, 0.6);
        }

        .cursor::after { 
            content: '▋'; 
            animation: blink 1s infinite; 
            color: var(--neon);
            text-shadow: 
                0 0 9px var(--neon),
                0 0 18px var(--neon);
        }

        .corner { position: absolute; width: 30px; height: 30px; border: 2px solid var(--neon); z-index: 5; pointer-events: none; }
        .corner.tl { top: -2px; left: -2px; border-right: none; border-bottom: none; clip-path: polygon(0 0, 100% 0, 0 100%); }
        .corner.tr { top: -2px; right: -2px; border-left: none; border-bottom: none; clip-path: polygon(0 0, 100% 0, 100% 100%); }
        .corner.bl { bottom: -2px; left: -2px; border-right: none; border-top: none; clip-path: polygon(0 0, 0 100%, 100% 100%); }
        .corner.br { bottom: -2px; right: -2px; border-left: none; border-top: none; clip-path: polygon(100% 0, 100% 100%, 0 100%); }

        .depth-layer { position: absolute; width: 100%; height: 100%; border: 1px solid rgba(0, 242, 255, 0.1); pointer-events: none; clip-path: inherit; }
        .depth-layer.l1 { transform: translateZ(-10px); opacity: 0.3; }
        .depth-layer.l2 { transform: translateZ(-20px); opacity: 0.2; }
        .depth-layer.l3 { transform: translateZ(-30px); opacity: 0.1; }

        .particle {
            position: fixed; width: 2px; height: 2px; background: var(--neon);
            border-radius: 50%; pointer-events: none; z-index: 2;
            animation: particle-float 15s linear infinite;
        }
        @keyframes particle-float {
            0% { transform: translate(0, 100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; } 90% { opacity: 1; }
            100% { transform: translate(200px, -100px) rotate(360deg); opacity: 0; }
        }

        .back-circle {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 50px; height: 50px; border: 1px solid var(--neon); border-radius: 50%;
            background: rgba(0, 5, 10, 0.8); backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 100; box-shadow: 0 0 15px rgba(0, 242, 255, 0.3);
        }
        .back-circle svg { width: 24px; height: 24px; fill: none; stroke: var(--neon); stroke-width: 2; }
    </style>
</head>
<body>

    <div class="overlay-dim"></div>

    <script>
        for(let i = 0; i < 30; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.left = Math.random() * 100 + 'vw';
            p.style.animationDelay = Math.random() * 15 + 's';
            p.style.animationDuration = (Math.random() * 10 + 10) + 's';
            document.body.appendChild(p);
        }
    </script>

    <div class="hologram-container">
        <div class="depth-layer l1"></div>
        <div class="depth-layer l2"></div>
        <div class="depth-layer l3"></div>

        <div class="screen">
            <div class="corner tl"></div>
            <div class="corner tr"></div>
            <div class="corner bl"></div>
            <div class="corner br"></div>

            <div class="header">
                <h1>AI LEGACY V1.0</h1>
                <div class="status">CHIẾN LƯỢC TÍCH LŨY</div>
            </div>

            <div class="content" id="output"></div>
        </div>
    </div>

    <div class="back-circle" onclick="window.location.href='./lenhAI.html'">
        <svg viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
    </div>

    <script>
        // --- BỘ THU TÍN HIỆU ĐỔI NỀN (GIỮ NGUYÊN) ---
        window.addEventListener('storage', (e) => {
            if (e.key === 'AURA_COMMAND_BG' && e.newValue) {
                const targetBg = e.newValue;
                document.body.style.backgroundImage = `url('./${targetBg}')`;
                localStorage.setItem('user_lobby_bg', targetBg);
                console.log("AI Scanner: Đã đồng bộ nền -> " + targetBg);
            }
        });

        window.onload = function() {
            const savedBg = localStorage.getItem('user_lobby_bg');
            if (savedBg) {
                document.body.style.backgroundImage = `url('./${savedBg}')`;
            } else {
                document.body.style.backgroundImage = `url('./farfuture01.png')`;
            }
            runAnalysis(); // Kích hoạt lệnh
        };

        const output = document.getElementById('output');
        
        function printLine(text, type = 'normal', delay = 0) {
            return new Promise(resolve => {
                setTimeout(() => {
                    const div = document.createElement('div');
                    let newType = type;
                    if (type === 'warn') newType = 'error'; 
                    
                    div.className = `line ${newType}`;
                    div.innerHTML = text; 
                    output.appendChild(div);
                    output.scrollTop = output.scrollHeight; 
                    resolve();
                }, delay);
            });
        }

        // --- [NEW] LOGIC CHIẾN LƯỢC TÍCH LŨY (LỆNH 04) ---
        async function runAnalysis() {
            await printLine("> Đang kết nối giao thức Legacy...", "system", 200);
            await printLine("> Đang truy xuất dữ liệu từ các chu kỳ quá khứ...", "system", 800);

            // 1. LẤY DỮ LIỆU
            const rawHist = localStorage.getItem('hist_v3');
            const history = rawHist ? JSON.parse(rawHist) : [];
            
            // Dữ liệu hiện tại để so sánh
            const rawAppData = localStorage.getItem('app_data_v4');
            const appData = rawAppData ? JSON.parse(rawAppData) : { totalBudget: 0, wallets: [] };
            
            // 2. GÁC CỔNG DỮ LIỆU (GATEKEEPER)
            if (history.length === 0) {
                await printLine("[SYSTEM]: Không tìm thấy hồ sơ lưu trữ (Legacy Data).", "error", 1500);
                await printLine("Giao thức tích lũy yêu cầu ít nhất 1 chu kỳ đã kết toán để xác định hệ số kỷ luật.", "system", 2000);
                return;
            }

            // 3. TÍNH TOÁN DI SẢN (LEGACY)
            // Tổng tích lũy từ quá khứ
            const totalLegacy = history.reduce((sum, h) => sum + (h.balance || 0), 0);
            
            // Kỷ lục cao nhất
            const maxRecord = Math.max(...history.map(h => h.balance || 0));
            const bestMonth = history.find(h => h.balance === maxRecord);

            // Trung bình lịch sử
            const avgHistory = totalLegacy / history.length;

            // Số dư chu kỳ hiện tại (Tạm tính)
            const currentTotalSpent = (appData.wallets || []).reduce((acc, w) => acc + (w.spent || 0), 0) * 1000;
            const currentTotalBudget = (appData.totalBudget || 0) * 1000;
            const currentBalance = currentTotalBudget - currentTotalSpent;

            // 4. HIỂN THỊ KẾT QUẢ
            await printLine(`[INFO]: Tổng số dư tích lũy qua các đời: ${totalLegacy.toLocaleString('vi-VN')} VNĐ.`, "normal", 1500);
            await printLine(`> Kỷ lục cao nhất: ${maxRecord.toLocaleString('vi-VN')} VNĐ (Kỳ: ${bestMonth ? bestMonth.name : 'N/A'}).`, "system", 2000);

            // 5. ĐÁNH GIÁ & SO SÁNH (COMPARE)
            const diffPercent = avgHistory !== 0 ? ((currentBalance - avgHistory) / Math.abs(avgHistory)) * 100 : 0;
            const diffDisplay = Math.abs(diffPercent).toFixed(1);

            if (currentBalance >= avgHistory) {
                await printLine(`[COMPARE]: Chu kỳ này đang tốt hơn ${diffDisplay}% so với trung bình lịch sử.`, "success", 3000);
            } else {
                await printLine(`⚠ CẢNH BÁO: Hiệu suất kỷ luật đang giảm sút ${diffDisplay}% so với mức trung bình.`, "error", 3000);
            }

            // 6. XẾP HẠNG (RANK)
            const isAllPositive = history.every(h => h.balance >= 0);
            const isAllNegative = history.every(h => h.balance < 0);

            if (isAllPositive && currentBalance > 0) {
                await printLine(`[RANK]: [KỶ LUẬT THÉP] - Chuỗi bất bại.`, "highlight", 4000);
            } else if (isAllNegative) {
                await printLine(`[RANK]: [BÁO ĐỘNG ĐỎ] - Cần tái cấu trúc tài chính ngay lập tức.`, "error", 4000);
            } else if (currentBalance > 0) {
                await printLine(`[RANK]: [TIỀM NĂNG] - Đang đi đúng hướng.`, "success", 4000);
            } else {
                await printLine(`[RANK]: [BẤT ỔN] - Cần kiểm soát chi tiêu chặt chẽ hơn.`, "system", 4000);
            }

            // 7. TẦM NHÌN (ADVISE)
            // Giả định mục tiêu ước nguyện
            // Nếu có tính năng Ước Nguyện thì tốt, tạm thời dùng con số giả định dựa trên tích lũy
            const estimatedCycles = currentBalance > 0 ? Math.ceil(50000000 / currentBalance) : "∞"; 
            
            if (currentBalance > 0) {
                await printLine(`[ADVISE]: Duy trì phong độ này để đạt mục tiêu [Mục tiêu lớn] trong khoảng ${estimatedCycles} chu kỳ tới.`, "highlight", 5000);
            } else {
                await printLine(`[ADVISE]: Cần đưa số dư về dương để kích hoạt lộ trình đạt [Mục tiêu lớn].`, "error", 5000);
            }

            await printLine("> Đang chờ lệnh người dùng... <span class='cursor'></span>", "normal", 6000);
        }
    </script>
</body>
</html>
