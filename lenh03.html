<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI OPTIMIZER - RESOURCE ALLOCATION</title>
    <style>
        /* --- 1. CẤU HÌNH GIAO DIỆN (GIỮ NGUYÊN TỪ LENH01) --- */
        :root {
            --neon: #00f2ff;
            --neon-green: #00ff88;
            --neon-pink: #ff00ff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: #000 no-repeat center bottom / cover fixed;
            height: 100vh; width: 100vw;
            overflow: hidden;
            font-family: 'Courier New', monospace;
            color: var(--neon);
            display: flex; align-items: center; justify-content: center;
            perspective: 1500px;
            touch-action: none;
            transition: background-image 0.5s ease-in-out;
        }

        .overlay-dim {
            position: fixed; inset: 0;
            background: rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(5px);
            z-index: 1; pointer-events: none;
        }

        .hologram-container {
            position: relative; z-index: 10;
            width: 90vw; max-width: 700px; 
            height: 500px;
            transform-style: preserve-3d;
            animation: float 6s ease-in-out infinite;
            margin-top: -30px;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotateX(5deg) rotateY(-5deg); }
            50% { transform: translateY(-15px) rotateX(5deg) rotateY(-5deg); }
        }

        .screen {
            position: relative; width: 100%; height: 100%;
            background: linear-gradient(135deg, rgba(0, 242, 255, 0.05), rgba(0, 242, 255, 0.1));
            border: 2px solid var(--neon);
            box-shadow: 0 0 40px rgba(0, 242, 255, 0.4), inset 0 0 60px rgba(0, 242, 255, 0.2);
            transform-style: preserve-3d;
            overflow: hidden;
            display: flex; flex-direction: column;
            clip-path: polygon(
                20px 0, calc(100% - 20px) 0, 100% 20px, 100% calc(100% - 20px),
                calc(100% - 20px) 100%, 20px 100%, 0 calc(100% - 20px), 0 20px
            );
        }

        .screen::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 242, 255, 0.03) 2px, rgba(0, 242, 255, 0.03) 4px),
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0, 242, 255, 0.03) 2px, rgba(0, 242, 255, 0.03) 4px);
            pointer-events: none; z-index: 2;
        }

        .screen::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px;
            background: linear-gradient(90deg, transparent, var(--neon), transparent);
            box-shadow: 0 0 20px var(--neon);
            animation: scan 3s linear infinite; z-index: 3; opacity: 0.6;
        }
        @keyframes scan { 
            0% { transform: translateY(0); } 100% { transform: translateY(600px); } 
        }

        .header {
            position: relative; padding: 15px 30px;
            border-bottom: 2px solid rgba(0, 242, 255, 0.3);
            background: rgba(0, 5, 10, 0.85);
            z-index: 10; flex-shrink: 0;
        }
        .header h1 {
            font-size: 18px; letter-spacing: 3px;
            text-shadow: 
                0 0 12px var(--neon),
                0 0 28px var(--neon),
                0 0 50px var(--neon);
            animation: glow-text 2s ease-in-out infinite;
        }
        @keyframes glow-text {
            0%, 100% { 
                text-shadow: 
                    0 0 12px var(--neon), 
                    0 0 28px var(--neon),
                    0 0 50px var(--neon); 
            }
            50% { 
                text-shadow: 
                    0 0 24px var(--neon), 
                    0 0 60px var(--neon), 
                    0 0 100px var(--neon),
                    0 0 140px rgba(0, 242, 255, 0.6);
            }
        }
        .status {
            font-size: 11px; 
            color: var(--neon-green); 
            margin-top: 5px;
            display: flex; align-items: center; gap: 8px;
            text-shadow: 
                0 0 7px var(--neon-green),
                0 0 14px var(--neon-green),
                0 0 24px rgba(0, 255, 136, 0.7);
        }
        .status::before {
            content: ''; width: 6px; height: 6px; background: var(--neon-green);
            border-radius: 50%; box-shadow: 0 0 8px var(--neon-green); animation: blink 1s infinite;
        }
        @keyframes blink { 50% { opacity: 0.3; } }

        .content {
            padding: 20px 30px; flex-grow: 1; 
            overflow-y: auto;
            position: relative; z-index: 4;
            touch-action: pan-y;
            -webkit-overflow-scrolling: touch;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .content::-webkit-scrollbar { 
            display: none; 
        }

        .line {
            margin-bottom: 10px; font-size: 13px; letter-spacing: 1px;
            text-shadow: 
                0 0 6px var(--neon),
                0 0 14px var(--neon),
                0 0 24px rgba(0, 242, 255, 0.8);
            opacity: 0;
            transform: translateX(-10px); animation: text-appear 0.3s forwards;
        }
        @keyframes text-appear { to { opacity: 1; transform: translateX(0); } }

        .line.success {
            color: var(--neon-green);
            text-shadow: 
                0 0 8px var(--neon-green),
                0 0 18px var(--neon-green),
                0 0 32px rgba(0, 255, 136, 0.85);
        }

        .line.error {
            color: #ff0066;
            font-weight: bold;
            text-shadow: 
                0 0 9px #ff0066,
                0 0 20px #ff0066,
                0 0 38px rgba(255, 0, 102, 0.8);
        }

        .line.highlight {
            color: var(--neon-pink);
            font-weight: bold;
            text-shadow: 
                0 0 10px var(--neon-pink),
                0 0 24px var(--neon-pink),
                0 0 45px rgba(255, 0, 255, 0.8);
        }

        .line.system {
            color: #ffffff;
            font-style: italic;
            text-shadow: 
                0 0 5px rgba(136, 136, 136, 0.9),
                0 0 10px rgba(136, 136, 136, 0.6);
        }

        .cursor::after { 
            content: '▋'; 
            animation: blink 1s infinite; 
            color: var(--neon);
            text-shadow: 
                0 0 9px var(--neon),
                0 0 18px var(--neon);
        }

        .corner { position: absolute; width: 30px; height: 30px; border: 2px solid var(--neon); z-index: 5; pointer-events: none; }
        .corner.tl { top: -2px; left: -2px; border-right: none; border-bottom: none; clip-path: polygon(0 0, 100% 0, 0 100%); }
        .corner.tr { top: -2px; right: -2px; border-left: none; border-bottom: none; clip-path: polygon(0 0, 100% 0, 100% 100%); }
        .corner.bl { bottom: -2px; left: -2px; border-right: none; border-top: none; clip-path: polygon(0 0, 0 100%, 100% 100%); }
        .corner.br { bottom: -2px; right: -2px; border-left: none; border-top: none; clip-path: polygon(100% 0, 100% 100%, 0 100%); }

        .depth-layer { position: absolute; width: 100%; height: 100%; border: 1px solid rgba(0, 242, 255, 0.1); pointer-events: none; clip-path: inherit; }
        .depth-layer.l1 { transform: translateZ(-10px); opacity: 0.3; }
        .depth-layer.l2 { transform: translateZ(-20px); opacity: 0.2; }
        .depth-layer.l3 { transform: translateZ(-30px); opacity: 0.1; }

        .particle {
            position: fixed; width: 2px; height: 2px; background: var(--neon);
            border-radius: 50%; pointer-events: none; z-index: 2;
            animation: particle-float 15s linear infinite;
        }
        @keyframes particle-float {
            0% { transform: translate(0, 100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; } 90% { opacity: 1; }
            100% { transform: translate(200px, -100px) rotate(360deg); opacity: 0; }
        }

        .back-circle {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 50px; height: 50px; border: 1px solid var(--neon); border-radius: 50%;
            background: rgba(0, 5, 10, 0.8); backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 100; box-shadow: 0 0 15px rgba(0, 242, 255, 0.3);
        }
        .back-circle svg { width: 24px; height: 24px; fill: none; stroke: var(--neon); stroke-width: 2; }
    </style>
</head>
<body>

    <div class="overlay-dim"></div>

    <script>
        for(let i = 0; i < 30; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.left = Math.random() * 100 + 'vw';
            p.style.animationDelay = Math.random() * 15 + 's';
            p.style.animationDuration = (Math.random() * 10 + 10) + 's';
            document.body.appendChild(p);
        }
    </script>

    <div class="hologram-container">
        <div class="depth-layer l1"></div>
        <div class="depth-layer l2"></div>
        <div class="depth-layer l3"></div>

        <div class="screen">
            <div class="corner tl"></div>
            <div class="corner tr"></div>
            <div class="corner bl"></div>
            <div class="corner br"></div>

            <div class="header">
                <h1>AI OPTIMIZER V1.0</h1>
                <div class="status">TỐI ƯU HÓA NGUỒN LỰC</div>
            </div>

            <div class="content" id="output"></div>
        </div>
    </div>

    <div class="back-circle" onclick="window.location.href='./lenhAI.html'">
        <svg viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
    </div>

    <script>
        // --- BỘ THU TÍN HIỆU ĐỔI NỀN (GIỮ NGUYÊN) ---
        window.addEventListener('storage', (e) => {
            if (e.key === 'AURA_COMMAND_BG' && e.newValue) {
                const targetBg = e.newValue;
                document.body.style.backgroundImage = `url('./${targetBg}')`;
                localStorage.setItem('user_lobby_bg', targetBg);
                console.log("AI Scanner: Đã đồng bộ nền -> " + targetBg);
            }
        });

        window.onload = function() {
            const savedBg = localStorage.getItem('user_lobby_bg');
            if (savedBg) {
                document.body.style.backgroundImage = `url('./${savedBg}')`;
            } else {
                document.body.style.backgroundImage = `url('./farfuture01.png')`;
            }
            runAnalysis(); // Kích hoạt lệnh tối ưu
        };

        const output = document.getElementById('output');
        
        function printLine(text, type = 'normal', delay = 0) {
            return new Promise(resolve => {
                setTimeout(() => {
                    const div = document.createElement('div');
                    let newType = type;
                    if (type === 'warn') newType = 'error'; 
                    
                    div.className = `line ${newType}`;
                    div.innerHTML = text; 
                    output.appendChild(div);
                    output.scrollTop = output.scrollHeight; 
                    resolve();
                }, delay);
            });
        }

        // --- [NEW] LOGIC TỐI ƯU NGÂN SÁCH (LỆNH 03) ---
        async function runAnalysis() {
            await printLine("> Đang kết nối giao thức bảo mật...", "system", 200);
            await printLine("> Đang kích hoạt giao thức tối ưu hóa nguồn quỹ [OPTIMIZER]...", "system", 800);

            // 1. LẤY DỮ LIỆU
            const startDateStr = localStorage.getItem('AURA_START_DATE');
            const rawData = localStorage.getItem('app_data_v4');
            const appData = rawData ? JSON.parse(rawData) : { wallets: [] };
            const wallets = appData.wallets || [];

            // 2. TÍNH TOÁN TIẾN ĐỘ CHU KỲ (TIME PROGRESS)
            let timeProgress = 0; // 0.0 -> 1.0 (0% -> 100%)
            const cycleDays = 30; // Giả định chu kỳ chuẩn 30 ngày
            
            if (startDateStr) {
                const parts = startDateStr.split('/');
                const startObj = new Date(parts[2], parts[1]-1, parts[0]);
                const now = new Date();
                const diffTime = Math.abs(now - startObj);
                const daysPassed = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                timeProgress = daysPassed / cycleDays;
            }

            // Tính tổng tiền đã tiêu
            const totalSpent = wallets.reduce((sum, w) => sum + (w.spent || 0), 0);
            // Lọc ra các ví có set ngân sách (alloc > 0) để phân tích
            const activeWallets = wallets.filter(w => w.alloc > 0);

            // 3. GÁC CỔNG DỮ LIỆU (GATEKEEPER)
            if (totalSpent <= 0 || activeWallets.length < 2) {
                await printLine("[SYSTEM]: Hệ thống chưa phát hiện biến động dòng tiền hoặc danh sách ví quá ít.", "error", 1500);
                await printLine("Giao thức tối ưu yêu cầu dữ liệu thực tế từ nhiều nguồn quỹ.", "system", 2000);
                return;
            }

            await printLine(`> Đã quét ${activeWallets.length} thực thể ví khả dụng. Tiến độ chu kỳ: ${(timeProgress*100).toFixed(0)}%`, "normal", 1500);

            // 4. BỘ LỌC PHÂN TÍCH (FILTERS)
            let criticalList = []; // Ví nguy cấp
            let surplusList = [];  // Ví dư thừa

            for (let w of activeWallets) {
                const ratio = w.spent / w.alloc; // Tỷ lệ sử dụng (vd: 0.8 là 80%)
                
                // Lọc Nguy cấp: Tiêu > 80% khi thời gian < 50%
                if (ratio > 0.8 && timeProgress < 0.5) {
                    criticalList.push(w);
                }
                
                // Lọc Dư thừa: Tiêu < 10% khi thời gian > 50%
                if (ratio < 0.1 && timeProgress > 0.5) {
                    surplusList.push(w);
                }
            }

            // 5. KẾT LUẬN & ĐỀ XUẤT
            if (criticalList.length > 0 && surplusList.length > 0) {
                // TRƯỜNG HỢP LÝ TƯỞNG: CÓ CẢ THỪA VÀ THIẾU -> ĐIỀU CHUYỂN
                const source = surplusList[0]; // Lấy ví thừa đầu tiên
                const target = criticalList[0]; // Lấy ví thiếu đầu tiên
                
                // Đề xuất chuyển 20% ngân sách của ví thừa sang ví thiếu
                const transferAmount = Math.floor(source.alloc * 0.2) * 1000;

                await printLine(`> Phát hiện dòng tiền đóng băng tại thực thể [${source.name}]...`, "normal", 2500);
                await printLine(`⚠ CẢNH BÁO: Thực thể [${target.name}] đang chịu áp lực chi tiêu cực đại.`, "error", 3500);
                await printLine(`> Lệnh: Điều chuyển ${transferAmount.toLocaleString()} VNĐ từ quỹ [${source.name}] sang [${target.name}] để cân bằng hệ thống.`, "highlight", 4500);
                await printLine(`Hệ thống đã sẵn sàng cho kịch bản tái phân bổ. Độ an toàn tăng 15%.`, "success", 5500);

            } else if (criticalList.length > 0) {
                // CHỈ CÓ THIẾU -> CẢNH BÁO
                const target = criticalList[0];
                await printLine(`⚠ CẢNH BÁO: Thực thể [${target.name}] sắp vỡ trận (Usage: ${(target.spent/target.alloc*100).toFixed(0)}%).`, "error", 2500);
                await printLine(`> Không tìm thấy nguồn quỹ dư thừa nào để bù đắp.`, "system", 3500);
                await printLine(`> Đề xuất: Kích hoạt gói cứu trợ khẩn cấp (Nạp thêm tiền).`, "highlight", 4500);

            } else if (surplusList.length > 0) {
                // CHỈ CÓ THỪA -> KHEN NGỢI
                const source = surplusList[0];
                await printLine(`> Phát hiện dòng tiền nhàn rỗi tại [${source.name}].`, "success", 2500);
                await printLine(`> Đề xuất: Chuyển phần dư vào quỹ Tiết Kiệm hoặc Đầu Tư.`, "highlight", 3500);
                
            } else {
                // KHÔNG CÓ GÌ BẤT THƯỜNG
                await printLine("HỆ THỐNG CÂN BẰNG. Các dòng tiền di chuyển đúng quỹ đạo.", "success", 2500);
                await printLine("> Đề xuất: Không cần can thiệp.", "highlight", 3500);
            }

            await printLine("> Đang chờ lệnh người dùng... <span class='cursor'></span>", "normal", 6500);
        }
    </script>
</body>
</html>
