<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SYSTEM CORE - EXTENDED</title>
    
    <link rel="stylesheet" href="avatarframe.css">
    <script src="nguoigaccong.js"></script>
    <script src="avatarframe.js"></script>

    <style>
        /* --- GI·ªÆ NGUY√äN CSS G·ªêC C·ª¶A B·∫†N --- */
        :root { --neon: #00f2ff; }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%;
            background: #02050a url('./farfuture01.png') center bottom / cover no-repeat fixed;
            font-family: 'Segoe UI', sans-serif; color: #fff; 
            
            /* --- C√ÅC L·ªÜNH KH√ìA M√ÄN H√åNH --- */
            overflow: hidden !important;      
            overflow-x: hidden !important;    
            overflow-y: hidden !important;    
            position: fixed;                  
            touch-action: none;               
            overscroll-behavior: none;        
            
            transition: background-image 0.5s ease-in-out;
        }

        #explosion-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 100; 
        }
        
        /* --- KHUNG HUD M·ªöI --- */
        #hud-container {
            position: absolute; 
            top: -20px; 
            left: 32%; 
            transform: translateX(-50%); 
            width: 500px; 
            max-width: 100%; 
            height: 200px; 
            z-index: 20;
            pointer-events: none; 
        }

        #hudCanvas {
            position: absolute; top: 0; left: 0;
            filter: drop-shadow(0 0 5px rgba(0, 242, 255, 0.2));
        }

        #profile-trigger {
            position: absolute;
            top: 50px; 
            left: 100px; 
            width: 100px; 
            height: 100px; 
            border-radius: 50%;
            cursor: pointer;
            pointer-events: auto; 
            z-index: 25;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #hud-avatar-img {
            width: 100%; height: 100%; 
            border-radius: 50%; 
            object-fit: cover;
            display: none; 
            position: relative; 
            z-index: 1;
        }

        #hud-frame-target {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.85); 
            width: 140px; height: 140px;
            pointer-events: none;
            z-index: 2;
            display: flex; justify-content: center; align-items: center;
        }

        .hud-text {
            position: absolute;
            top: 92px;
            left: 235px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 14px;
            width: 250px; 
            letter-spacing: 4px;
            color: var(--neon);
            text-shadow: 0 0 8px var(--neon);
            pointer-events: none;
        }

        #dust-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1; 
        }

        .dust {
            position: absolute; background: var(--neon); border-radius: 50%;
            box-shadow: 0 0 6px var(--neon), 0 0 12px rgba(0, 242, 255, 0.6);
            opacity: 0.6; animation: float linear infinite;
        }

        @keyframes float {
            0%   { transform: translateY(110vh) scale(0.3); opacity: 0; }
            15%  { opacity: 0.8; }
            80%  { opacity: 0.6; }
            100% { transform: translateY(-20vh) scale(1); opacity: 0; }
        }

        .task-wrapper {
            position: relative; width: 100%; height: 110px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .svg-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; overflow: visible;
        }

        .beam { fill: none; stroke-linecap: round; stroke-linejoin: round; transition: all 0.3s ease; }
        .core-beam { stroke: var(--neon); stroke-width: 1.5; fill: rgba(0, 242, 255, 0.02); }
        .shell-beam { stroke: var(--neon); stroke-width: 2.5; opacity: 0.8; }

        .content { display: flex; flex-direction: column; align-items: center; z-index: 2; pointer-events: none; }
        .icon { 
            width: 32px; height: 32px; fill: none; stroke: var(--neon); stroke-width: 1.2; 
            margin-bottom: 8px; filter: url(#neonGlow); transition: 0.3s;
        }
        .label { 
            color: var(--neon); font-size: 11px; letter-spacing: 1.5px; font-weight: bold; 
            text-shadow: 0 0 5px var(--neon); transition: 0.3s; text-transform: uppercase;
        }

        .task-wrapper:hover .shell-beam { stroke: var(--neon); stroke-width: 3.5; filter: url(#strongGlow); opacity: 1; }
        .task-wrapper:hover .core-beam { stroke: var(--neon); stroke-width: 2; filter: url(#strongGlow); fill: rgba(0, 242, 255, 0.15); }
        .task-wrapper:hover .icon { transform: scale(1.1); filter: drop-shadow(0 0 8px var(--neon)); }
        .task-wrapper:hover .label { text-shadow: 0 0 15px var(--neon); }
        .task-wrapper:active .core-beam { stroke: #fff; filter: url(#strongGlow); }

        #viewport {
            width: 100vw; height: 100vh; 
            overflow: hidden; position: relative; z-index: 10;
        }
        
        #page-container {
            display: flex; width: 100vw; height: 100%;
        }

        .page {
            width: 100vw; height: 100%;
            display: flex; flex-direction: column; align-items: center;
            overflow: hidden; 
        }

        .grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px 20px; 
            width: 90%; max-width: 500px; 
            margin: 150px auto 100px auto; 
            position: relative;
        }

        .ctrl-btn {
            position: fixed; bottom: 40px; width: 55px; height: 55px;
            border: 1px solid var(--neon); border-radius: 50%;
            background: rgba(0, 5, 10, 0.6); backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 100; box-shadow: 0 0 10px rgba(0, 242, 255, 0.2);
            transition: 0.3s;
            -webkit-tap-highlight-color: transparent;
        }
        .ctrl-btn:active { background: var(--neon); box-shadow: 0 0 25px var(--neon); }
        .ctrl-btn svg { width: 24px; height: 24px; fill: none; stroke: var(--neon); stroke-width: 2; transition: 0.3s; }
        .ctrl-btn:active svg { stroke: #000; }
        
        .btn-left { left: 30px; }
        .btn-right { right: 30px; }

        /* --- CSS CHO POPUP NEON --- */
        #devModal, #warningModal {
            display: none; /* ·∫®n m·∫∑c ƒë·ªãnh */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 5, 10, 0.85);
            backdrop-filter: blur(8px);
            z-index: 9999;
            align-items: center; justify-content: center;
            flex-direction: column;
        }
        .modal-box {
            width: 80%; max-width: 320px;
            padding: 25px;
            border: 1px solid var(--neon);
            background: rgba(0, 20, 30, 0.9);
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.2), inset 0 0 10px rgba(0, 242, 255, 0.1);
            text-align: center;
            position: relative;
            transform: scale(0.9);
            animation: modalPop 0.3s forwards;
        }
        
        /* --- STYLE RI√äNG CHO C·∫¢NH B√ÅO ƒê·ªé --- */
        .modal-box.warning {
            border: 1px solid #ff4444; 
            background: rgba(20, 0, 0, 0.95);
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.2), inset 0 0 10px rgba(255, 0, 0, 0.1);
        }
        .modal-box.warning h2 {
            color: #ff4444; 
            text-shadow: 0 0 10px #ff0000;
            border-bottom: 1px dashed rgba(255, 68, 68, 0.3);
        }

        @keyframes modalPop { to { transform: scale(1); } }
        
        .modal-box h2 {
            margin: 0 0 15px 0; color: var(--neon); 
            font-size: 18px; letter-spacing: 2px; text-transform: uppercase;
            text-shadow: 0 0 10px var(--neon);
            border-bottom: 1px dashed rgba(0, 242, 255, 0.3);
            padding-bottom: 10px;
        }
        .modal-box p {
            font-size: 13px; color: #ccc; line-height: 1.5; margin-bottom: 25px;
        }
        .modal-btn {
            background: transparent; border: 1px solid var(--neon);
            color: var(--neon); padding: 10px 20px;
            font-family: inherit; font-weight: bold; cursor: pointer;
            transition: 0.3s; text-transform: uppercase;
        }
        .modal-btn:hover, .modal-btn:active {
            background: var(--neon); color: #000; box-shadow: 0 0 15px var(--neon);
        }
        
    </style>
</head>
<body>
    
    <canvas id="explosion-canvas"></canvas>

    <div id="hud-container">
        <canvas id="hudCanvas"></canvas>
        
        <div id="profile-trigger" onclick="checkProfileAccess()">
            <img id="hud-avatar-img" src="" alt="Avatar">
            <div id="hud-frame-target"></div> 
        </div>

        <div class="hud-text">SYSTEM CORE</div>
    </div>

    <div id="dust-container"></div>

    <div class="ctrl-btn btn-left" onclick="window.location.href='hologram0.html'">
        <svg viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
    </div>

    <div class="ctrl-btn btn-right" onclick="showDevModal()">
        <svg viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
    </div>

    <div id="devModal">
        <div class="modal-box">
            <h2>TH√îNG B√ÅO H·ªÜ TH·ªêNG</h2>
            <p>T√≠nh nƒÉng n√†y ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.<br>Vui l√≤ng quay l·∫°i sau!</p>
            <button class="modal-btn" onclick="closeDevModal()">ƒê√É R√ï üê°‚úå</button>
        </div>
    </div>

    <div id="warningModal">
        <div class="modal-box warning">
            <h2>QUY·ªÄN H·∫†N KH√îNG ƒê·ª¶</h2>
            <p id="warningMsg">B·∫°n c·∫ßn n√¢ng c·∫•p quy·ªÅn h·∫°n ƒë·ªÉ truy c·∫≠p.</p>
            <button class="modal-btn" onclick="closeWarningModal()">ƒê√É R√ï</button>
        </div>
    </div>

    <svg style="position: absolute; width: 0; height: 0; overflow: hidden;">
        <defs>
            <filter id="neonGlow"><feGaussianBlur stdDeviation="2" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
            <filter id="strongGlow"><feGaussianBlur stdDeviation="5" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>

            <linearGradient id="grad1" x1="0" y1="0" x2="1" y2="1"><stop offset="10%" stop-color="white" /><stop offset="40%" stop-color="#222" /><stop offset="60%" stop-color="#222" /><stop offset="90%" stop-color="white" /></linearGradient>
            <mask id="mask1"><rect x="-100" y="-100" width="500" height="500" fill="url(#grad1)" /></mask>
            <linearGradient id="grad2" x1="1" y1="0" x2="0" y2="1"><stop offset="10%" stop-color="white" /><stop offset="40%" stop-color="#222" /><stop offset="60%" stop-color="#222" /><stop offset="90%" stop-color="white" /></linearGradient>
            <mask id="mask2"><rect x="-100" y="-100" width="500" height="500" fill="url(#grad2)" /></mask>
            <linearGradient id="grad3" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stop-color="white" /><stop offset="30%" stop-color="#111" /><stop offset="70%" stop-color="#111" /><stop offset="95%" stop-color="white" /></linearGradient>
            <mask id="mask3"><rect x="-100" y="-100" width="500" height="500" fill="url(#grad3)" /></mask>
             <linearGradient id="grad4" x1="0" y1="0" x2="1" y2="0"><stop offset="10%" stop-color="white" /><stop offset="45%" stop-color="#000" /><stop offset="55%" stop-color="#000" /><stop offset="90%" stop-color="white" /></linearGradient>
            <mask id="mask4"><rect x="-100" y="-100" width="500" height="500" fill="url(#grad4)" /></mask>
        </defs>
    </svg>

    <div id="viewport">
        <div id="page-container">
            
            <div class="page">
                <div class="grid">
                    
                    <div class="task-wrapper" onclick="checkTaskAccess('bieudo.html', 2, 'OPERATOR')">
                        <svg class="svg-container" viewBox="-20 -20 240 160">
                            <path class="beam core-beam" filter="url(#neonGlow)" d="M 15,0 L 185,0 L 200,15 L 200,105 L 185,120 L 15,120 L 0,105 L 0,15 Z" />
                            <path class="beam shell-beam" filter="url(#neonGlow)" mask="url(#mask1)" d="M 15,-12 L 185,-12 L 212,15 L 212,105 L 185,132 L 15,132 L -12,105 L -12,15 Z" />
                        </svg>
                        <div class="content">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M21 21H3V3"/><path d="M18 17l-6-6-4 4-5-5"/></svg>
                            <div class="label">D·ªÆ LI·ªÜU S·ªê</div>
                        </div>
                    </div>

                    <div class="task-wrapper" onclick="checkTaskAccess('lenhAI.html', 3, 'ARCHITECT')">
                        <svg class="svg-container" viewBox="-20 -20 240 160">
                            <path class="beam core-beam" filter="url(#neonGlow)" d="M 15,0 L 185,0 L 200,15 L 200,105 L 185,120 L 15,120 L 0,105 L 0,15 Z" />
                            <path class="beam shell-beam" filter="url(#neonGlow)" mask="url(#mask2)" d="M 15,-12 L 185,-12 L 212,15 L 212,105 L 185,132 L 15,132 L -12,105 L -12,15 Z" />
                        </svg>
                        <div class="content">
                            <svg class="icon" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"/><line x1="12" y1="2" x2="12" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/></svg>
                            <div class="label">PH√ÇN T√çCH AI</div>
                        </div>
                    </div>

                    <div class="task-wrapper" onclick="window.location.href='vip.html'">
                        <svg class="svg-container" viewBox="-20 -20 240 160">
                            <path class="beam core-beam" filter="url(#neonGlow)" d="M 15,0 L 185,0 L 200,15 L 200,105 L 185,120 L 15,120 L 0,105 L 0,15 Z" />
                            <path class="beam shell-beam" filter="url(#neonGlow)" mask="url(#mask3)" d="M 15,-12 L 185,-12 L 212,15 L 212,105 L 185,132 L 15,132 L -12,105 L -12,15 Z" />
                        </svg>
                        <div class="content">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
                            <div class="label">N√ÇNG C·∫§P</div>
                        </div>
                    </div>

                    <div class="task-wrapper" onclick="window.location.href='baomat.html'">
                        <svg class="svg-container" viewBox="-20 -20 240 160">
                            <path class="beam core-beam" filter="url(#neonGlow)" d="M 15,0 L 185,0 L 200,15 L 200,105 L 185,120 L 15,120 L 0,105 L 0,15 Z" />
                            <path class="beam shell-beam" filter="url(#neonGlow)" mask="url(#mask4)" d="M 15,-12 L 185,-12 L 212,15 L 212,105 L 185,132 L 15,132 L -12,105 L -12,15 Z" />
                        </svg>
                        <div class="content">
                            <svg class="icon" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                            <div class="label">B·∫¢O M·∫¨T</div>
                        </div>
                    </div>

                    <div class="task-wrapper" onclick="checkTaskAccess('time.html', 3, 'ARCHITECT')">
                        <svg class="svg-container" viewBox="-20 -20 240 160">
                            <path class="beam core-beam" filter="url(#neonGlow)" d="M 15,0 L 185,0 L 200,15 L 200,105 L 185,120 L 15,120 L 0,105 L 0,15 Z" />
                            <path class="beam shell-beam" filter="url(#neonGlow)" mask="url(#mask1)" d="M 15,-12 L 185,-12 L 212,15 L 212,105 L 185,132 L 15,132 L -12,105 L -12,15 Z" />
                        </svg>
                        <div class="content">
                            <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            <div class="label">L·ªäCH</div>
                        </div>
                    </div>

                    <div class="task-wrapper" onclick="checkTaskAccess('uocnguyen.html', 2, 'OPERATOR')">
                        <svg class="svg-container" viewBox="-20 -20 240 160">
                            <path class="beam core-beam" filter="url(#neonGlow)" d="M 15,0 L 185,0 L 200,15 L 200,105 L 185,120 L 15,120 L 0,105 L 0,15 Z" />
                            <path class="beam shell-beam" filter="url(#neonGlow)" mask="url(#mask2)" d="M 15,-12 L 185,-12 L 212,15 L 212,105 L 185,132 L 15,132 L -12,105 L -12,15 Z" />
                        </svg>
                        <div class="content">
                            <svg class="icon" viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                            <div class="label">∆Ø·ªöC NGUY·ªÜN</div>
                        </div>
                    </div>

                </div>
            </div>
            
        </div>
    </div>

    <script>
        // --- LOGIC KI·ªÇM TRA QUY·ªÄN H·∫†N ƒêA NƒÇNG ---
        function checkTaskAccess(url, requiredLevel, rankName) {
            if (typeof NguoiGacCong !== 'undefined') {
                const identity = NguoiGacCong.traLoiDanhTinh();
                
                // N·∫øu c·∫•p ƒë·ªô hi·ªán t·∫°i < C·∫•p y√™u c·∫ßu -> CH·∫∂N
                if (identity.level < requiredLevel) {
                    showWarning(rankName);
                } else {
                    // ƒê·ªß quy·ªÅn -> CHO QUA
                    window.location.href = url;
                }
            } else {
                // Fallback n·∫øu l·ªói script: Cho qua
                window.location.href = url;
            }
        }

        // --- H√ÄM KI·ªÇM TRA TRUY C·∫¨P PROFILE (M·ªöI B·ªî SUNG) ---
        function checkProfileAccess() {
            if (typeof NguoiGacCong !== 'undefined') {
                const identity = NguoiGacCong.traLoiDanhTinh();
                // Level = 4 (Orchestrator) -> profileultra
                if (identity.level === 4) {
                    window.location.href = 'profileultra.html';
                } else {
                    // Level 1, 2, 3 -> profilebasic
                    window.location.href = 'profilebasic.html';
                }
            } else {
                window.location.href = 'profilebasic.html';
            }
        }

        function showWarning(rankName) {
            const modal = document.getElementById('warningModal');
            const msg = document.getElementById('warningMsg');
            
            // C·∫≠p nh·∫≠t n·ªôi dung gi·∫£i th√≠ch t√πy theo Rank y√™u c·∫ßu
            msg.innerHTML = `B·∫°n c·∫ßn n√¢ng c·∫•p l√™n quy·ªÅn h·∫°n ${rankName} ƒë·ªÉ truy c·∫≠p t√≠nh nƒÉng n√†y.`;
            modal.style.display = 'flex';
        }

        function closeWarningModal() {
            document.getElementById('warningModal').style.display = 'none';
        }

        // --- C√ÅC H√ÄM C≈® GI·ªÆ NGUY√äN ---
        function showDevModal() {
            document.getElementById('devModal').style.display = 'flex';
        }
        function closeDevModal() {
            document.getElementById('devModal').style.display = 'none';
        }

        const hudCanvas = document.getElementById('hudCanvas');
        const hudCtx = hudCanvas.getContext('2d');
        const W = 500; const H = 200; 
        hudCanvas.width = W; hudCanvas.height = H;
        const COLOR = "#00f2ff"; 

        function drawHudFrame() {
            hudCtx.clearRect(0, 0, W, H);
            const r = 60; const barH = 55; const drawingWidth = 320; 
            const startX = (W - drawingWidth) / 2; const cy = H / 2; const cx = startX + r;                 
            const barStart = cx + r - 5; const barLen = startX + drawingWidth - 30;

            hudCtx.shadowBlur = 0; hudCtx.strokeStyle = "rgba(0, 242, 255, 0.15)"; hudCtx.lineWidth = 1;
            hudCtx.setLineDash([2, 4]); hudCtx.beginPath(); hudCtx.arc(cx, cy, r, 0, Math.PI * 2); hudCtx.stroke();
            hudCtx.setLineDash([]); hudCtx.beginPath(); hudCtx.arc(cx, cy, r - 8, 0, Math.PI * 2); hudCtx.stroke();

            hudCtx.strokeStyle = COLOR; hudCtx.shadowColor = COLOR; hudCtx.shadowBlur = 10; 
            hudCtx.lineWidth = 2; hudCtx.lineCap = "round"; hudCtx.lineJoin = "round";
            let topY = cy - (barH / 2); let botY = cy + (barH / 2);

            hudCtx.beginPath();
            hudCtx.moveTo(barStart, topY); hudCtx.lineTo(barStart + 15, topY); hudCtx.lineTo(barStart + 25, topY - 5); 
            hudCtx.lineTo(barLen - 40, topY - 5); hudCtx.lineTo(barLen - 30, topY); hudCtx.lineTo(barLen, topY); 
            hudCtx.lineTo(barLen + 15, cy - 8); hudCtx.lineTo(barLen + 15, cy + 8); hudCtx.lineTo(barLen, botY); 
            hudCtx.lineTo(barStart + 80, botY); hudCtx.lineTo(barStart + 70, botY + 5); hudCtx.lineTo(barStart + 35, botY + 5); 
            hudCtx.lineTo(barStart + 25, botY); hudCtx.lineTo(barStart, botY); hudCtx.stroke();

            hudCtx.shadowBlur = 5; hudCtx.lineWidth = 1; hudCtx.beginPath();
            hudCtx.moveTo(barStart + 40, botY + 12); hudCtx.lineTo(barStart + 100, botY + 12); hudCtx.stroke();
            hudCtx.lineWidth = 2; hudCtx.beginPath();
            hudCtx.moveTo(barStart + 12, topY + 8); hudCtx.lineTo(barStart + 6, botY - 8); hudCtx.stroke();
        }
        drawHudFrame();

        function loadLobbyAvatar() {
            const savedAvatar = localStorage.getItem('USER_AVATAR_BASE64');
            const img = document.getElementById('hud-avatar-img');
            if (savedAvatar) { img.src = savedAvatar; img.style.display = 'block'; }
            if (typeof AvatarFrameManager !== 'undefined') { AvatarFrameManager.render('hud-frame-target'); }
        }

        const cv = document.getElementById("explosion-canvas");
        const ctx = cv.getContext("2d");
        let shards = [];
        function resize() { cv.width = window.innerWidth; cv.height = window.innerHeight; }
        window.onresize = resize; resize();

        class NeonShard {
            constructor(x, y, isSparkle = false) {
                this.x = x; this.y = y; this.isSparkle = isSparkle;
                this.life = 1.0; this.decay = isSparkle ? 0.03 : 0.02 + Math.random() * 0.1;
                const angle = Math.random() * Math.PI * 2; const speed = isSparkle ? (1 + Math.random() * 4) : (3 + Math.random() * 4);
                this.vx = Math.cos(angle) * speed; this.vy = Math.sin(angle) * speed;
                this.size = isSparkle ? (Math.random() * 2) : (5 + Math.random() * 8);
                this.widthRatio = 0.3 + Math.random() * 0.4; this.rot = angle; this.vRot = (Math.random() - 0.5) * 0.3;
            }
            update() { this.vx *= 0.95; this.vy *= 0.95; this.x += this.vx; this.y += this.vy; this.rot += this.vRot; this.life -= this.decay; }
            draw() {
                if(this.life <= 0) return;
                ctx.globalCompositeOperation = "lighter"; ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.rot);
                const alpha = this.life; const flicker = 0.8 + Math.random() * 0.2; 
                ctx.beginPath();
                if (this.isSparkle) { ctx.arc(0, 0, this.size, 0, Math.PI * 2); } 
                else { ctx.moveTo(0, -this.size); ctx.lineTo(this.size * this.widthRatio, this.size); ctx.lineTo(-this.size * this.widthRatio, this.size); }
                ctx.closePath();
                ctx.shadowBlur = (this.isSparkle ? 5 : 20) * alpha; ctx.shadowColor = "#00f2ff";
                ctx.strokeStyle = `rgba(0, 242, 255, ${alpha * flicker})`; ctx.lineWidth = this.isSparkle ? 1 : 1.5; ctx.stroke();
                if (!this.isSparkle) { ctx.fillStyle = `rgba(255, 255, 255, ${alpha * 0.15})`; ctx.fill(); ctx.strokeStyle = `rgba(255, 255, 255, ${alpha * 0.8})`; ctx.lineWidth = 0.5; ctx.stroke(); } 
                else { ctx.fillStyle = `rgba(255, 255, 255, ${alpha})`; ctx.fill(); }
                ctx.restore(); ctx.globalCompositeOperation = "source-over";
            }
        }
        function animate() {
            ctx.clearRect(0, 0, cv.width, cv.height); shards = shards.filter(s => s.life > 0); shards.forEach(s => { s.update(); s.draw(); }); requestAnimationFrame(animate);
        }
        animate();
        window.addEventListener('mousedown', e => { for(let i=0; i<3; i++) shards.push(new NeonShard(e.clientX, e.clientY, false)); for(let i=0; i<5; i++) shards.push(new NeonShard(e.clientX, e.clientY, true)); });
        window.addEventListener('touchstart', e => { const t = e.touches[0]; for(let i=0; i<3; i++) shards.push(new NeonShard(t.clientX, t.clientY, false)); for(let i=0; i<5; i++) shards.push(new NeonShard(t.clientX, t.clientY, true)); });

        function createDust() {
            const container = document.getElementById('dust-container'); const particleCount = 80;
            for (let i = 0; i < particleCount; i++) {
                const dust = document.createElement('div'); dust.className = 'dust';
                const size = Math.random() * 4 + 2; dust.style.width = size + 'px'; dust.style.height = size + 'px';
                dust.style.left = Math.random() * 100 + 'vw';
                const duration = Math.random() * 12 + 8; dust.style.animationDuration = duration + 's';
                dust.style.animationDelay = '-' + (Math.random() * duration) + 's'; container.appendChild(dust);
            }
        }
        createDust();

        window.addEventListener('storage', (e) => {
            if (e.key === 'AURA_COMMAND_BG' && e.newValue) {
                const targetBg = e.newValue;
                document.body.style.backgroundImage = `url('./${targetBg}')`;
                localStorage.setItem('user_lobby_bg', targetBg);
                console.log("ƒêi·ªÅu h√†nh: ƒê√£ ghi ƒë√® n·ªÅn h·ªá th·ªëng th√†nh -> " + targetBg);
            }
        });

        window.onload = function() {
            const savedBg = localStorage.getItem('user_lobby_bg');
            if (savedBg) { document.body.style.backgroundImage = `url('./${savedBg}')`; } 
            else { document.body.style.backgroundImage = `url('./farfuture01.png')`; }
            loadLobbyAvatar();
        };
    </script>
</body>
</html>
